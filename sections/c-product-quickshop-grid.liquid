{% comment %}
  TV - Product Grid with Quickview (One modal per block)
  - Blocks = products
  - 3 columns desktop, 2 mobile
  - Each block has + button with top/left positioning
  - Each block renders its own modal
  - Custom color + size selectors update correct variant ID
{% endcomment %}

<style>
  /* ================================
     TV WILD GRID
  ================================ */

  .tv-wild__title{
    font-size: 36px;
    font-weight: 400;
    margin-bottom: 30px;
  }

  .tv-wild__grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:20px;
  }

  @media(max-width:768px){
    .tv-wild__grid{
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
  }

  .tv-wild__card{
    position:relative;
  }

  .tv-wild__img{
    position:relative;
    width:100%;
    aspect-ratio:1/1;
    overflow:hidden;
  }

  .tv-wild__img img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  /* + button */
  .tv-wild__plus{
    position:absolute;
    width:28px;
    height:28px;
    border-radius:50%;
    background:#fff;
    border:none;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 4px 15px rgba(0,0,0,0.15);
    transition:.2s ease;
  }

  .tv-wild__plus:hover{
    transform:scale(1.1);
  }

  /* ================================
     MODAL
  ================================ */

  .tv-qv{
    position:fixed;
    inset:0;
    display:none;
    z-index:999;
  }

  .tv-qv.is-open{
    display:block;
  }

  .tv-qv__overlay{
    position:absolute;
    display: block !important;
    inset:0;
    background:rgba(0,0,0,0.4);
  }

  .tv-qv__panel{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:90%;
    max-width:500px;
    background:#fff;
    overflow:hidden;
    display:grid;
    grid-template-columns:1fr;
    padding: 16px 8px;
  }

  @media(max-width:768px){
    .tv-qv__panel{
      grid-template-columns:1fr;
      max-height:90vh;
      overflow-y:auto;
    }
  }

  .tv-qv__close{
    position:absolute;
    top:16px;
    right:16px;
    background:none;
    border:none;
    font-size:18px;
    cursor:pointer;
    z-index: 5;
  }

  .tv-qv__content{
    display:flex;
    padding: 24px 12px;
  }

  .tv-qv__media{
    background: #f4f4f4;
    flex: 0 0 40%;
  }

  .tv-qv__media img{
    width: 100%;
    height: 100%;
    aspect-ratio: 5 / 6;
    object-fit: cover;
    display: block;
  }
.tv-qv__form {
    padding: 0 12px 20px;
}
  /* right side */
  .product__info-container{
    padding:10px;
  }

  .product__title h2{
    font-size:20px;
    margin-bottom:10px;
  }

  /* ================================
     COLOR SWITCHER
  ================================ */

  .tv-color-switch{
    position:relative;
    display:flex;
    border:1px solid #ddd;
    overflow:hidden;
    margin-bottom:20px;
  }

  .tv-color-option{
    flex:1;
    padding:1px 0px;
    font-size:18px;
    cursor:pointer;
    position:relative;
    display:flex;
    align-items:center;
    gap:10px;
    z-index:2;
    user-select: none;
  }

  .tv-color-option .color-bar{
    width: 0.5rem;
    height: 50px;
    border: 0.05rem solid #00000091;
  }

  .tv-color-slider{
    position:absolute;
    display: block !important;
    top:0;
    bottom:0;
    width:50%;
    background:#000;
    transition:.3s ease;
    z-index:1;
  }

  .tv-color-option.active{
    color:#fff;
  }

  /* ================================
     SIZE DROPDOWN
  ================================ */

  .tv-size-select{
    width:100%;
    padding:15px 12px;
    border:1px solid #ddd;
    border-radius:6px;
    margin-bottom:20px;
    font-size:14px;
  }

  /* add to cart */
  .tv-qv-form .product-form__submit{
    width:100%;
    font-size: 16px;
    text-transform: uppercase;
    padding: 16px;
    margin-top: 32px;
  }

  .tv-qv-form .product-form__submit[disabled]{
    opacity: .55;
    cursor: not-allowed;
  }
</style>

<section class="tv-wild color-{{ section.settings.color_scheme }}">
  <div class="page-width tv-wild" style="padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px 0;">
    {% if section.settings.heading != blank %}
      <h2 class="tv-wild__title">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="tv-wild__grid">
      {% for block in section.blocks %}
        {% assign p = block.settings.product %}
        {% assign block_id = block.id %}

        <div class="tv-wild__card" {{ block.shopify_attributes }}>
          <div class="tv-wild__img">
            {% if p.featured_media %}
              <img
                src="{{ p.featured_media | image_url: width: 900 }}"
                alt="{{ p.featured_media.alt | escape }}"
                loading="lazy"
              >
            {% endif %}

            <button
              type="button"
              class="tv-wild__plus"
              style="top: {{ block.settings.plus_top }}%; left: {{ block.settings.plus_left }}%;"
              aria-label="Quick view {{ p.title | escape }}"
              data-tv-open-qv="{{ block_id }}"
            >
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>

          <!-- Modal for this block -->
          <div class="tv-qv" data-tv-qv-modal id="tv-qv-{{ block_id }}" aria-hidden="true">
            <div class="tv-qv__overlay" data-tv-qv-overlay></div>

            <div class="tv-qv__panel" role="dialog" aria-modal="true" aria-label="Quick view">
              <button class="tv-qv__close" type="button" data-tv-qv-close aria-label="Close">✕</button>

              <div class="tv-qv__content">
                <!-- Media -->
                <div class="tv-qv__media">
                  {% if p.featured_media %}
                    <img src="{{ p.featured_media | image_url: width: 900 }}" alt="{{ p.featured_media.alt | escape }}">
                  {% endif %}
                </div>

                <!-- Info -->
                <div class="product__info-container">
                  <div class="product__title"><h2>{{ p.title }}</h2></div>
                  
                  {% render 'price', product: p, use_variant: true, show_badges: false %}
                  
                  <div class="product__title"><p>{{ p.description }}</p></div>
                  
                </div>
            </div>
            <div class="tv-qv__form">                
                <!-- Variants JSON (needed for correct selection) -->
                <script type="application/json" data-tv-variants>
                {{ p.variants | json }}
                </script>

                {% assign color_option_index = nil %}
                {% assign size_option_index = nil %}

                {% for option in p.options_with_values %}
                {% if option.name == 'Color' %}
                    {% assign color_option_index = forloop.index0 %}
                {% endif %}
                {% if option.name == 'Size' %}
                    {% assign size_option_index = forloop.index0 %}
                {% endif %}
                {% endfor %}

                {% if color_option_index != nil %}
                    <span>Color</span>
                    <div class="tv-color-switch" data-color-switch>
                        <div class="tv-color-slider"></div>
                        
                        {% for value in p.options_with_values[color_option_index].values %}
                            <div
                                class="tv-color-option {% if forloop.first %}active{% endif %}"
                                data-color-value="{{ value | escape }}"
                    >
                        <span class="color-bar" style="background: {{ value | downcase }}"></span>
                        {{ value }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if size_option_index != nil %}
                <span>Size</span>
                <select class="tv-size-select" data-tv-size>
                    {% for value in p.options_with_values[size_option_index].values %}
                    <option value="{{ value | escape }}">{{ value }}</option>
                    {% endfor %}
                </select>
                {% endif %}

                <!-- REAL ADD TO CART FORM -->
                <form
                method="post"
                action="/cart/add"
                id="tv-qv-form-{{ block_id }}"
                class="tv-qv-form"
                enctype="multipart/form-data"
                >
                <input type="hidden" name="form_type" value="product">
                <input type="hidden" name="utf8" value="✓">

                <!-- Variant ID (updated by JS) -->
                <input
                    type="hidden"
                    name="id"
                    value="{{ p.selected_or_first_available_variant.id }}"
                    data-tv-variant-id
                >

                <button
                    type="submit"
                    name="add"
                    class="button button--full-width product-form__submit"
                    data-tv-atc
                >
                    Add to cart
                </button>
                </form>
            </div>      
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>

<script>
  (function () {
    const buttons = document.querySelectorAll('[data-tv-open-qv]');
    let openModal = null;

    function closeAll() {
      if (openModal) {
        openModal.classList.remove('is-open');
        openModal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('overflow-hidden');
        openModal = null;
      }
    }

    buttons.forEach((btn) => {
      const modalId = btn.getAttribute('data-tv-open-qv');
      const modal = document.getElementById('tv-qv-' + modalId);
      const closeBtn = modal.querySelector('[data-tv-qv-close]');
      const overlay = modal.querySelector('[data-tv-qv-overlay]');

      btn.addEventListener('click', () => {
        closeAll();
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('overflow-hidden');
        openModal = modal;
        closeBtn.focus();
      });

      closeBtn.addEventListener('click', closeAll);
      overlay.addEventListener('click', closeAll);
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAll();
    });
  })();
</script>

<script>
  (function () {
    document.querySelectorAll('.tv-qv').forEach((modal) => {
      const variantsJSON = modal.querySelector('[data-tv-variants]');
      if (!variantsJSON) return;

      const variants = JSON.parse(variantsJSON.textContent);

      const variantInput = modal.querySelector('[data-tv-variant-id]');
      const atcButton = modal.querySelector('[data-tv-atc]');
      const colorSwitch = modal.querySelector('[data-color-switch]');
      const sizeSelect = modal.querySelector('[data-tv-size]');

      function getSelectedColor() {
        const active = colorSwitch?.querySelector('.tv-color-option.active');
        return active ? active.getAttribute('data-color-value') : null;
      }

      function getSelectedSize() {
        return sizeSelect ? sizeSelect.value : null;
      }

      function findMatchingVariant(color, size) {
        // Assumes option1 = Color, option2 = Size
        // This matches MOST Shopify stores with Color/Size
        return variants.find((v) => {
          const matchesColor = !color || v.option1 === color || v.option2 === color;
          const matchesSize = !size || v.option1 === size || v.option2 === size;
          return matchesColor && matchesSize;
        });
      }

      function updateVariant() {
        const color = getSelectedColor();
        const size = getSelectedSize();

        const match = findMatchingVariant(color, size);
        if (!match) return;

        variantInput.value = match.id;

        // Disable ATC if unavailable
        if (match.available) {
          atcButton.removeAttribute('disabled');
          atcButton.textContent = 'Add to cart';
        } else {
          atcButton.setAttribute('disabled', 'disabled');
          atcButton.textContent = 'Sold out';
        }
      }

      // COLOR SWITCH LOGIC
      if (colorSwitch) {
        const options = colorSwitch.querySelectorAll('.tv-color-option');
        const slider = colorSwitch.querySelector('.tv-color-slider');

        function moveSlider(el) {
          const rect = el.getBoundingClientRect();
          const parentRect = colorSwitch.getBoundingClientRect();
          {% comment %} slider.style.width = rect.width + 'px'; {% endcomment %}
          slider.style.left = (rect.left - parentRect.left) + 'px';
        }

        options.forEach((opt) => {
          opt.addEventListener('click', () => {
            options.forEach((o) => o.classList.remove('active'));
            opt.classList.add('active');
            moveSlider(opt);
            updateVariant();
          });
        });

        const active = colorSwitch.querySelector('.active');
        if (active) moveSlider(active);
      }

      // SIZE SELECT LOGIC
      if (sizeSelect) {
        sizeSelect.addEventListener('change', updateVariant);
      }

      // Initial set
      updateVariant();
    });
  })();
</script>

{% schema %}
{
  "name": "TV - PRD Grid",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Tisso vison in the wild"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "default": 40
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" },
        { "type": "range", "id": "plus_top", "label": "+ button top (%)", "min": 0, "max": 100, "step": 1, "default": 15 },
        { "type": "range", "id": "plus_left", "label": "+ button left (%)", "min": 0, "max": 100, "step": 1, "default": 70 }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "TV - PRD Grid"
    }
  ]
}
{% endschema %}
